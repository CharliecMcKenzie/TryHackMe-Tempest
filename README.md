# TryHackMe Tempest Challenge

## Introduction
This lab aims to introduce the process of analysing endpoint and network logs from a compromised asset. Given the artefacts, we will aim to uncover the incident from the Tempest machine. In this scenario, I will be tasked to be one of the Incident Responders that will focus on handling and analysing the captured artefacts of a compromised machine. 

## Walkthrough
### Initial Access - Malicious Document

Before starting the log analysis, I generated the SHA-256 hash for each file.
<p align="center">
<img src="https://i.imgur.com/X97URoT.png" height="80%" width="80%" alt="hash"/>

In this incident, I will act as an Incident Responder from an alert triaged by one of my Security Operations Center analysts. The analyst has confirmed that the alert has a CRITICAL severity that needs further investigation.
As reported by the SOC analyst, the intrusion started from a malicious document. In addition, the analyst compiled the essential information generated by the alert as listed below:
- The malicious document has a .docÂ extension.
- The user downloaded the malicious document via chrome.exe.
- The malicious document then executed a chain of commands to attain code execution.

To find the name of the malicious document, I first used EvtxEcmd to parse the sysmon.evtx file into CSV format for analysis in Timeline Explorer. I then searched for '.doc' and identified the malicious document as free_magicules.doc.
<p align="center">
<img src="https://i.imgur.com/BuJyJ3Z.png" height="80%" width="80%" alt="convertformat"/>
<img src="https://i.imgur.com/7ZjrvWh.png" height="80%" width="80%" alt=".doc"/>

Next I needed to know the name of the compromised user and machine.
<p align="center">
<img src="https://i.imgur.com/PW4E0C8.png" height="80%" width="80%" alt="username"/>

I also needed the PID of the Microsoft Word process that opened the malicious document, which I had already identified earlier when locating free_magicules.doc. 
<p align="center">
<img src="https://i.imgur.com/lvYJ2Fw.png" height="80%" width="80%" alt="PID"/>

From the Sysmon logs, I needed to identify the IPv4 address linked to the malicious domain. After reviewing the logs, I found a suspicious DNS query to phishteam.xyz, matching the previously identified PID. With the destination IP address 167.71.199.191. 
<p align="center">
<img src="https://i.imgur.com/vzK8z2J.png" height="80%" width="80%" alt="DNS"/>
<img src="https://i.imgur.com/mibkXio.png" height="80%" width="80%" alt="IP"/>

I identified the Base64-encoded string in the malicious payload executed by the document by searching for 'base64.' This search returned a log with a parent process ID of 496.
<p align="center">
<img src="https://i.imgur.com/ZlZYSPL.png" height="80%" width="80%" alt="Base64"/>

After identifying the payload executed by the document, I noticed that msdt.exe was invoked. A quick Google search revealed the CVE number of the exploit used by the attacker to achieve remote code execution. 
<p align="center">
<img src="https://i.imgur.com/ZoIKzrA.png" height="80%" width="80%" alt="CVE"/>

### Initial Access - Stage 2 execution

Based on the initial findings, we discovered that there is a stage 2 execution:

- The document has successfully executed an encoded base64 command.
- Decoding this string reveals the exact command chain executed by the malicious document.

Decoding the Base64 string using CyberChef revealed the full target path of the payload and the file  written to the system. 
<p align="center">
<img src="https://i.imgur.com/3LJDNw6.png" height="80%" width="80%" alt="cyberchef"/>

The implanted payload is executed when the user logs into the machine. The command triggered upon the compromised user's successful login was identified by filtering the logs for the domain phishteam.xyz, which was extracted from the decoded Base64 string. 
<p align="center">
<img src="https://i.imgur.com/ttggZFU.png" height="80%" width="80%" alt="command"/>

By filtering for phishteam.xyz, I also discovered a malicious binary along with its SHA-256 hash, which was downloaded for stage 2 execution. 
<p align="center">
<img src="https://i.imgur.com/uSbODtD.png" height="80%" width="80%" alt="binaryhash"/>

The stage 2 payload establishes a connection to a C2 server at the domain resolvecyber.xyz on port 80. 
<p align="center">
<img src="https://i.imgur.com/m0u6ibZ.png" height="80%" width="80%" alt="c2domain"/>
<img src="https://i.imgur.com/rDcwcoS.png" height="80%" width="80%" alt="c2port"/>

